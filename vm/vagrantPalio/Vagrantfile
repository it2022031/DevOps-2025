Vagrant.configure("2") do |config|
  config.vm.box = "generic/ubuntu2204"
  config.vm.boot_timeout = 600

  # Shared folder (default είναι ok, αλλά το αφήνω explicit)
  config.vm.synced_folder ".", "/vagrant", type: "virtualbox"

  # -------- control --------
  config.vm.define "control", primary: true do |h|
    h.vm.hostname = "control"
    h.vm.network "private_network", ip: "192.168.56.10"

    h.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 2
    end

    # Generates SSH key and exports public key to /vagrant/control.pub
    h.vm.provision "shell", path: "scripts/key.sh"
  end

  # Helper provision snippet (adds control.pub to authorized_keys safely)
  add_control_key = <<-SHELL
    set -e
    mkdir -p /home/vagrant/.ssh
    touch /home/vagrant/.ssh/authorized_keys
    chmod 700 /home/vagrant/.ssh
    chmod 600 /home/vagrant/.ssh/authorized_keys

    if [ -f /vagrant/control.pub ]; then
      grep -qxF "$(cat /vagrant/control.pub)" /home/vagrant/.ssh/authorized_keys || cat /vagrant/control.pub >> /home/vagrant/.ssh/authorized_keys
    else
      echo "ERROR: /vagrant/control.pub not found (control VM key not generated yet)"
      exit 1
    fi

    chown -R vagrant:vagrant /home/vagrant/.ssh
  SHELL

  # -------- appserver --------
  config.vm.define "appserver" do |h|
    h.vm.hostname = "appserver"
    h.vm.network "private_network", ip: "192.168.56.101"

    h.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 2
    end

    h.vm.provision "shell", inline: add_control_key
  end

  # -------- dbserver --------
  config.vm.define "dbserver" do |h|
    h.vm.hostname = "dbserver"
    h.vm.network "private_network", ip: "192.168.56.102"

    h.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 2
    end

    h.vm.provision "shell", inline: add_control_key
  end

  # -------- frontserver --------
  config.vm.define "frontserver" do |h|
    h.vm.hostname = "frontserver"
    h.vm.network "private_network", ip: "192.168.56.103"

    h.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 2
    end

    h.vm.provision "shell", inline: add_control_key
  end
end
