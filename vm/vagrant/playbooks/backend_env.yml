---
- name: Configure backend environment variables
  hosts: backend
  become: true

  vars:
    env_dir: /opt/DS-2025/backend
    env_file: /opt/DS-2025/backend/app.env

    db_host: 192.168.56.102
    db_port: 5432
    db_name: demo_db
    db_user: demo_user
    db_pass: demo_pass

    spring_profile: prod

    # MailHog (SMTP)
    mail_host: 192.168.56.101
    mail_port: 1025

    # MinIO
    minio_endpoint: http://192.168.56.101:9000
    minio_access_key: minioadmin
    minio_secret_key: minioadmin123

  tasks:
    - name: Ensure backend env directory exists
      file:
        path: "{{ env_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Write backend env file (idempotent)
      copy:
        dest: "{{ env_file }}"
        owner: root
        group: root
        mode: "0640"
        content: |
          SPRING_PROFILES_ACTIVE={{ spring_profile }}
          SPRING_DATASOURCE_URL=jdbc:postgresql://{{ db_host }}:{{ db_port }}/{{ db_name }}
          SPRING_DATASOURCE_USERNAME={{ db_user }}
          SPRING_DATASOURCE_PASSWORD={{ db_pass }}

          # MailHog (SMTP)
          SPRING_MAIL_HOST={{ mail_host }}
          SPRING_MAIL_PORT={{ mail_port }}

          # MinIO
          MINIO_ENDPOINT={{ minio_endpoint }}
          MINIO_ACCESS_KEY={{ minio_access_key }}
          MINIO_SECRET_KEY={{ minio_secret_key }}

    - name: Show env file location
      debug:
        msg: "Backend env file written at {{ env_file }}"
