---
- name: Build frontend (npm install + npm run build)
  hosts: front
  become: true

  vars:
    frontend_dir: "/opt/DS-2025/frontend/vue-argon-design-system-master"
    build_user: "vagrant"

  tasks:
    - name: Install deps (npm ci/install)
      become_user: "{{ build_user }}"
      shell: |
        set -e
        export NVM_DIR="$HOME/.nvm"
        . "$NVM_DIR/nvm.sh"
        cd "{{ frontend_dir }}"
        if [ -f package-lock.json ]; then npm ci; else npm install; fi
      args: { executable: /bin/bash }

    - name: Build (dist/)
      become_user: "{{ build_user }}"
      shell: |
        set -e
        export NVM_DIR="$HOME/.nvm"
        . "$NVM_DIR/nvm.sh"
        cd "{{ frontend_dir }}"
        npm run build
      args: { executable: /bin/bash }

    - name: Verify dist exists
      stat:
        path: "{{ frontend_dir }}/dist"
      register: dist_dir

    - name: Fail if dist missing
      fail:
        msg: "dist/ not created"
      when: not dist_dir.stat.exists
