---
- import_playbook: preflight_host.yml
# 0) Common fixes / prerequisites (all hosts)
- name: Common prep on all VMs
  hosts: all
  become: true
  tasks:
    - name: Ensure remote tmp dir exists
      file:
        path: "/tmp/.ansible-{{ lookup('env','USER') | default('ansible') }}"
        state: directory
        mode: "1777"

# 1) Database
- import_playbook: postgres.yml

# 2) Supporting services on backend host
- import_playbook: minio.yml
- import_playbook: mailhog.yml

# 3) Backend prerequisites + code
- import_playbook: java21.yml
- import_playbook: maven.yml

- import_playbook: clone_ds2025.yml
  vars:
    target_hosts: backend

# 4) Backend runtime
- import_playbook: backend_env.yml
- import_playbook: build_backend.yml
- import_playbook: backend_service.yml

# 5) Backend Nginx (proxy :80 -> :8080)
- import_playbook: nginx_install.yml
  vars:
    target_hosts: backend

- import_playbook: nginx_site.yml
  vars:
    target_hosts: backend
    nginx_site: ds2025
    upstream_host: 127.0.0.1
    upstream_port: 8080
    enable_api_proxy: false

- import_playbook: nginx_enable_site.yml
  vars:
    target_hosts: backend
    nginx_site: ds2025

- import_playbook: nginx_restart.yml
  vars:
    target_hosts: backend

# 6) Frontend prerequisites (nvm/node/npm) + code
- import_playbook: nvm_install.yml
- import_playbook: nvm_verify.yml

- import_playbook: clone_ds2025.yml
  vars:
    target_hosts: front

# 7) Frontend env + build + service (dist server)
- import_playbook: frontend_env.yml
- import_playbook: frontend_patch_localhost.yml
- import_playbook: frontend_build.yml
- import_playbook: frontend_service.yml

# 8) Front Nginx (proxy :80 -> :8081, and /api -> backend)
- import_playbook: nginx_install.yml
  vars:
    target_hosts: front

- import_playbook: nginx_site.yml
  vars:
    target_hosts: front
    nginx_site: ds2025-front
    upstream_host: 127.0.0.1
    upstream_port: 8081
    enable_api_proxy: true
    api_prefix: "/api/"
    api_upstream_host: 10.10.10.11
    api_upstream_port: 80

- import_playbook: nginx_enable_site.yml
  vars:
    target_hosts: front
    nginx_site: ds2025-front

- import_playbook: nginx_restart.yml
  vars:
    target_hosts: front

# 9) Healthchecks (τρέξε το στο τέλος μία φορά)
- import_playbook: healthcheck.yml
