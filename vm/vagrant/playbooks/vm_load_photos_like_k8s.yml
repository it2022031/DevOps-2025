---
- name: Load photos on DB VM using /vagrant/sqlData (no copy, k8s-like)
  hosts: db
  become: true

  vars:
    db_name: demo_db
    load_sql: /vagrant/sqlData/load_photos.sql
    photos_dir: /vagrant/sqlData/photos

  tasks:
    - name: Ensure load_photos.sql exists (synced)
      stat:
        path: "{{ load_sql }}"
      register: s1

    - name: Fail if load_photos.sql missing
      fail:
        msg: "Missing {{ load_sql }} (expected in vm/vagrant/sqlData/load_photos.sql)"
      when: not s1.stat.exists

    - name: Ensure photos dir exists (synced)
      stat:
        path: "{{ photos_dir }}"
      register: s2

    - name: Fail if photos dir missing
      fail:
        msg: "Missing {{ photos_dir }} (expected in vm/vagrant/sqlData/photos/)"
      when: not s2.stat.exists

    - name: Create stable symlinks for SQL paths
      shell: |
        set -e
        rm -rf /photos_src /photos
        ln -s "{{ photos_dir }}" /photos_src
        ln -s "{{ photos_dir }}" /photos
        ls -la /photos_src || true
      args:
        executable: /bin/bash

    - name: Run load_photos.sql as postgres
      shell: |
        set -euo pipefail
        sudo -u postgres psql -d "{{ db_name }}" -v ON_ERROR_STOP=1 -f "{{ load_sql }}"
      args:
        executable: /bin/bash

    - name: Sanity check property_photos count
      shell: |
        set -e
        sudo -u postgres psql -d "{{ db_name }}" -c "select count(*) as property_photos from property_photos;"
      args:
        executable: /bin/bash
      register: prop_count
      changed_when: false

    - debug:
        var: prop_count.stdout_lines
