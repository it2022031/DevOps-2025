---
- name: Seed PostgreSQL on VMs from /vagrant/sqlData/test_dedomena.sql
  hosts: backend
  become: true

  vars:
    db_host: "{{ hostvars['db'].ansible_host }}"
    db_port: 5432
    db_name: demo_db
    db_user: demo_user
    db_pass: demo_pass

    seed_sql_on_vm: /vagrant/sqlData/test_dedomena.sql

  tasks:
    - name: Ensure psql client exists on backend
      apt:
        name: postgresql-client
        state: present
        update_cache: yes

    - name: Ensure seed SQL exists on backend (synced folder)
      stat:
        path: "{{ seed_sql_on_vm }}"
      register: seed_sql_stat

    - name: Fail if seed SQL missing
      fail:
        msg: "Missing {{ seed_sql_on_vm }}. Ensure vm/vagrant/sqlData/test_dedomena.sql exists"
      when: not seed_sql_stat.stat.exists

    - name: Wait for DB reachable
      wait_for:
        host: "{{ db_host }}"
        port: "{{ db_port }}"
        timeout: 60

    - name: Run seed SQL
      shell: |
        set -euo pipefail
        export PGPASSWORD='{{ db_pass }}'
        psql -v ON_ERROR_STOP=1 -h '{{ db_host }}' -p '{{ db_port }}' -U '{{ db_user }}' -d '{{ db_name }}' -f '{{ seed_sql_on_vm }}'
      args:
        executable: /bin/bash

    - name: Sanity check counts (users/properties)
      shell: |
        set -euo pipefail
        export PGPASSWORD='{{ db_pass }}'
        psql -h '{{ db_host }}' -p '{{ db_port }}' -U '{{ db_user }}' -d '{{ db_name }}' -c \
        "select 'users' as t, count(*) from users
         union all
         select 'properties' as t, count(*) from properties;"
      args:
        executable: /bin/bash
      register: sanity
      changed_when: false

    - debug:
        var: sanity.stdout_lines
