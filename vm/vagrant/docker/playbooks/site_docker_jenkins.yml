---
- name: Deploy DS-2025 stack on dockerhost via docker compose (pull from GHCR)
  hosts: docker
  become: true

  vars:
    project_dir: /opt/DS-2025
    repo_url: "https://github.com/it2022031/DevOps-2025.git"
    repo_dest: "{{ project_dir }}/DevOps-2025"
    compose_dir: "{{ repo_dest }}/DevOps/Docker"

    docker_compose_bin: /usr/local/bin/docker-compose
    docker_compose_url: "https://github.com/docker/compose/releases/download/v2.24.6/docker-compose-linux-x86_64"

    # If GHCR images are private, set these (recommended via extra-vars in Jenkins):
    # ghcr_username: "it2022031"
    # ghcr_token: "<TOKEN_WITH_read:packages>"
    ghcr_registry: "ghcr.io"

  tasks:
    - name: Install prerequisites
      apt:
        name:
          - git
          - ca-certificates
          - curl
        state: present
        update_cache: yes
        cache_valid_time: 3600

    - name: Install Docker engine (Ubuntu repo)
      apt:
        name:
          - docker.io
        state: present

    - name: Ensure docker service is running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Create project directory
      file:
        path: "{{ project_dir }}"
        state: directory
        mode: "0755"

    - name: Clone or update repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ repo_dest }}"
        version: "main"
        force: yes

    - name: Ensure docker-compose.yml exists
      stat:
        path: "{{ compose_dir }}/docker-compose.yml"
      register: compose_stat

    - name: Fail if docker-compose.yml missing
      fail:
        msg: "Missing docker-compose.yml at {{ compose_dir }}/docker-compose.yml"
      when: not compose_stat.stat.exists

    # Detect if "docker compose" (v2 plugin) exists
    - name: Check docker compose v2 availability
      command: docker compose version
      register: compose_v2_check
      changed_when: false
      failed_when: false

    # If v2 plugin missing, install standalone docker-compose binary
    - name: Check if standalone docker-compose exists
      stat:
        path: "{{ docker_compose_bin }}"
      register: compose_bin

    - name: Install standalone docker-compose (if v2 missing and binary missing)
      get_url:
        url: "{{ docker_compose_url }}"
        dest: "{{ docker_compose_bin }}"
        mode: "0755"
      when: compose_v2_check.rc != 0 and not compose_bin.stat.exists

    # Optional: GHCR login (ONLY if credentials provided; for public images it is skipped)
    - name: GHCR login (if ghcr_username & ghcr_token provided)
      shell: |
        set -e
        echo "{{ ghcr_token }}" | docker login {{ ghcr_registry }} -u "{{ ghcr_username }}" --password-stdin
      args:
        executable: /bin/bash
      when:
        - ghcr_username is defined
        - ghcr_token is defined
        - ghcr_username | length > 0
        - ghcr_token | length > 0

    # Pull + Up (NO BUILD)
    - name: Compose pull (v2)
      command: docker compose pull
      args:
        chdir: "{{ compose_dir }}"
      when: compose_v2_check.rc == 0

    - name: Compose pull (v1 binary)
      command: "{{ docker_compose_bin }} pull"
      args:
        chdir: "{{ compose_dir }}"
      when: compose_v2_check.rc != 0

    - name: Compose up -d (v2) (NO BUILD)
      command: docker compose up -d
      args:
        chdir: "{{ compose_dir }}"
      when: compose_v2_check.rc == 0

    - name: Compose up -d (v1 binary) (NO BUILD)
      command: "{{ docker_compose_bin }} up -d"
      args:
        chdir: "{{ compose_dir }}"
      when: compose_v2_check.rc != 0

    - name: Show docker compose ps (v2)
      command: docker compose ps
      args:
        chdir: "{{ compose_dir }}"
      register: ps_out_v2
      changed_when: false
      when: compose_v2_check.rc == 0

    - name: Show docker compose ps (v1)
      command: "{{ docker_compose_bin }} ps"
      args:
        chdir: "{{ compose_dir }}"
      register: ps_out_v1
      changed_when: false
      when: compose_v2_check.rc != 0

    - name: Print docker compose ps
      debug:
        var: (ps_out_v2.stdout_lines if compose_v2_check.rc == 0 else ps_out_v1.stdout_lines)
