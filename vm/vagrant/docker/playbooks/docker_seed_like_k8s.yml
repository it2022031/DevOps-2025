---
- name: Seed DB in Docker from /vagrant/sqlData/test_dedomena.sql (K8s-like)
  hosts: docker
  become: true

  vars:
    compose_dir: "/vagrant/docker"
    db_name: "demo_db"
    db_user: "demo_user"
    seed_sql_on_dockerhost: "/vagrant/sqlData/test_dedomena.sql"
    seed_sql_in_container: "/tmp/test_dedomena.sql"

  tasks:
    - name: Ensure seed SQL exists on dockerhost (synced folder)
      stat:
        path: "{{ seed_sql_on_dockerhost }}"
      register: seed_stat

    - name: Fail if seed SQL missing
      fail:
        msg: "Missing {{ seed_sql_on_dockerhost }}. Ensure vm/vagrant/sqlData/test_dedomena.sql exists"
      when: not seed_stat.stat.exists

    - name: Bring stack up
      shell: |
        set -e
        cd "{{ compose_dir }}"
        /usr/local/bin/docker-compose up -d
      args:
        executable: /bin/bash

    - name: Wait until db is healthy
      shell: |
        set -e
        cd "{{ compose_dir }}"
        for i in $(seq 1 60); do
          if /usr/local/bin/docker-compose ps | grep -E "db" | grep -q "healthy"; then
            exit 0
          fi
          sleep 2
        done
        /usr/local/bin/docker-compose ps
        exit 1
      args:
        executable: /bin/bash

    - name: Copy seed SQL into db container
      shell: |
        set -e
        cd "{{ compose_dir }}"
        CID=$(/usr/local/bin/docker-compose ps -q db)
        test -n "$CID"
        docker cp "{{ seed_sql_on_dockerhost }}" "${CID}:{{ seed_sql_in_container }}"
      args:
        executable: /bin/bash

    - name: Run seed SQL inside db container
      shell: |
        set -e
        cd "{{ compose_dir }}"
        /usr/local/bin/docker-compose exec -T db sh -lc \
          'psql -U "{{ db_user }}" -d "{{ db_name }}" -v ON_ERROR_STOP=1 -f "{{ seed_sql_in_container }}"'
      args:
        executable: /bin/bash

    - name: Sanity check counts
      shell: |
        set -e
        cd "{{ compose_dir }}"
        /usr/local/bin/docker-compose exec -T db sh -lc "
          psql -U {{ db_user }} -d {{ db_name }} -c \"select 'users' as t, count(*) from users
          union all
          select 'properties' as t, count(*) from properties;\"
        "
      args:
        executable: /bin/bash
      register: sanity
      changed_when: false

    - debug:
        var: sanity.stdout_lines
