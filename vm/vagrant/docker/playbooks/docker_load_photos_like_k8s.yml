---
- name: Load photos in Docker from /vagrant/sqlData (K8s-like)
  hosts: docker
  become: true

  vars:
    compose_dir: "/vagrant/docker"
    db_name: "demo_db"
    db_user: "demo_user"

    photos_on_dockerhost: "/vagrant/sqlData/photos"
    load_sql_on_dockerhost: "/vagrant/sqlData/load_photos.sql"

    load_sql_in_container: "/tmp/load_photos.sql"

  tasks:
    - name: Ensure photos folder exists on dockerhost
      stat:
        path: "{{ photos_on_dockerhost }}"
      register: photos_stat

    - name: Fail if photos missing
      fail:
        msg: "Missing {{ photos_on_dockerhost }}. Ensure vm/vagrant/sqlData/photos exists"
      when: not photos_stat.stat.exists

    - name: Ensure load_photos.sql exists on dockerhost
      stat:
        path: "{{ load_sql_on_dockerhost }}"
      register: load_sql_stat

    - name: Fail if load_photos.sql missing
      fail:
        msg: "Missing {{ load_sql_on_dockerhost }}. Ensure vm/vagrant/sqlData/load_photos.sql exists"
      when: not load_sql_stat.stat.exists

    - name: Bring stack up
      shell: |
        set -e
        cd "{{ compose_dir }}"
        /usr/local/bin/docker-compose up -d
      args:
        executable: /bin/bash

    - name: Wait until db is healthy
      shell: |
        set -e
        cd "{{ compose_dir }}"
        for i in $(seq 1 60); do
          if /usr/local/bin/docker-compose ps | grep -E "db" | grep -q "healthy"; then
            exit 0
          fi
          sleep 2
        done
        /usr/local/bin/docker-compose ps
        exit 1
      args:
        executable: /bin/bash

    - name: Copy load_photos.sql into db container
      shell: |
        set -e
        cd "{{ compose_dir }}"
        CID=$(/usr/local/bin/docker-compose ps -q db)
        test -n "$CID"
        docker cp "{{ load_sql_on_dockerhost }}" "${CID}:{{ load_sql_in_container }}"
      args:
        executable: /bin/bash

    - name: Copy photos into db container (/photos_src)
      shell: |
        set -e
        cd "{{ compose_dir }}"
        CID=$(/usr/local/bin/docker-compose ps -q db)
        test -n "$CID"
        # recreate /photos_src with your synced photos
        /usr/local/bin/docker-compose exec -T db sh -lc 'rm -rf /photos_src && mkdir -p /photos_src'
        docker cp "{{ photos_on_dockerhost }}/." "${CID}:/photos_src"
      args:
        executable: /bin/bash

    - name: Normalize property_photos folder inside container (handle trailing-space case)
      shell: |
        set -e
        cd "{{ compose_dir }}"
        /usr/local/bin/docker-compose exec -T db sh -lc '
          set -e
          rm -rf /photos
          mkdir -p /photos

          # avatars
          if [ -d "/photos_src/avatar_photos" ]; then
            cp -a /photos_src/avatar_photos /photos/
          fi

          # property photos
          if [ -d "/photos_src/property_photos " ]; then
            cp -a "/photos_src/property_photos " "/photos/property_photos_tmp"
          elif [ -d "/photos_src/property_photos" ]; then
            cp -a "/photos_src/property_photos" "/photos/property_photos_tmp"
          else
            echo "No property_photos found under /photos_src"
            exit 1
          fi

          rm -rf /photos/property_photos
          mv /photos/property_photos_tmp /photos/property_photos
        '
      args:
        executable: /bin/bash

    - name: Run load_photos.sql inside db container
      shell: |
        set -e
        cd "{{ compose_dir }}"
        /usr/local/bin/docker-compose exec -T db sh -lc \
          'psql -U "{{ db_user }}" -d "{{ db_name }}" -v ON_ERROR_STOP=1 -f "{{ load_sql_in_container }}"'
      args:
        executable: /bin/bash

    - name: Sanity check property_photos count
      shell: |
        set -e
        cd "{{ compose_dir }}"
        /usr/local/bin/docker-compose exec -T db sh -lc \
          'psql -U "{{ db_user }}" -d "{{ db_name }}" -c "select count(*) as property_photos from property_photos;"'
      args:
        executable: /bin/bash
      register: prop_count
      changed_when: false

    - debug:
        var: prop_count.stdout_lines
