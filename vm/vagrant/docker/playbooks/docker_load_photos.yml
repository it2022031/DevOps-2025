---
# 0) Clone DS-2025 on dockerhost VM (so /opt/DS-2025 exists for volume mounts)
- import_playbook: ../../playbooks/clone_ds2025.yml
  vars:
    target_hosts: docker
    repo_url: "https://github.com/it2022031/DS-2025.git"
    project_dir: "/opt/DS-2025"
    repo_version: "main-branch"
    app_owner: "vagrant"
    version_file: "/opt/DS-2025/VERSION"

# 1) Load photos into Postgres (Docker)
- name: Load photos into PostgreSQL (docker db container)
  hosts: docker
  become: true

  vars:
    compose_dir: "/vagrant/docker"

    db_name: "demo_db"
    db_user: "demo_user"

    # IMPORTANT: load_photos.sql path inside the mounted repo
    load_photos_sql_in_container: "/ds2025/backend/demo/src/main/resources/db/migration/load_photos.sql"

  tasks:
    - name: Bring stack up (apply new mounts)
      command: /usr/local/bin/docker-compose up -d
      args:
        chdir: "{{ compose_dir }}"

    - name: Wait until db is healthy
      shell: |
        set -e
        cd "{{ compose_dir }}"
        for i in $(seq 1 60); do
          if /usr/local/bin/docker-compose ps | grep -E "db" | grep -q "healthy"; then
            echo "DB is healthy"
            exit 0
          fi
          sleep 2
        done
        echo "DB did not become healthy in time"
        /usr/local/bin/docker-compose ps
        exit 1
      args:
        executable: /bin/bash



    - name: Ensure load_photos.sql exists inside db container (via /ds2025 mount)
      shell: |
        set -e
        cd "{{ compose_dir }}"
        /usr/local/bin/docker-compose exec -T db sh -lc 'test -f "{{ load_photos_sql_in_container }}" && echo "OK: load_photos.sql found"'
      args:
        executable: /bin/bash

    - name: Copy photos into writable /photos inside db container (normalize property_photos)
      shell: |
        set -e
        cd "{{ compose_dir }}"
        /usr/local/bin/docker-compose exec -T db sh -lc '
          set -e

          # fresh writable dir
          rm -rf /photos
          mkdir -p /photos

          # copy avatars
          if [ -d "/photos_src/avatar_photos" ]; then
            cp -a /photos_src/avatar_photos /photos/
          fi

          # copy property photos (handle trailing-space folder if it exists)
          if [ -d "/photos_src/property_photos " ]; then
            cp -a "/photos_src/property_photos " "/photos/property_photos_tmp"
          elif [ -d "/photos_src/property_photos" ]; then
            cp -a "/photos_src/property_photos" "/photos/property_photos_tmp"
          else
            echo "No property_photos folder found under /photos_src"
            exit 1
          fi

          rm -rf /photos/property_photos
          mv /photos/property_photos_tmp /photos/property_photos

          echo "Photos prepared:"
          ls -la /photos
          ls -la /photos/property_photos | head -n 5 || true
        '
      args:
        executable: /bin/bash

    - name: Run load_photos.sql inside db container
      shell: |
        set -e
        cd "{{ compose_dir }}"
        /usr/local/bin/docker-compose exec -T db sh -lc '
          set -e
          psql -U "{{ db_user }}" -d "{{ db_name }}" -v ON_ERROR_STOP=1 -f "{{ load_photos_sql_in_container }}"
        '
      args:
        executable: /bin/bash

    - name: Sanity check property_photos count
      shell: |
        set -e
        cd "{{ compose_dir }}"
        /usr/local/bin/docker-compose exec -T db sh -lc '
          psql -U "{{ db_user }}" -d "{{ db_name }}" -c "select count(*) as property_photos from property_photos;"
        '
      args:
        executable: /bin/bash
      register: prop_count
      changed_when: false

    - debug:
        var: prop_count.stdout_lines

    - name: Sanity check avatars bytes (sample)
      shell: |
        set -e
        cd "{{ compose_dir }}"
        /usr/local/bin/docker-compose exec -T db sh -lc '
          psql -U "{{ db_user }}" -d "{{ db_name }}" -c "select username, profile_picture_filename, octet_length(profile_picture) as bytes from users order by id limit 10;"
        '
      args:
        executable: /bin/bash
      register: avatars
      changed_when: false

    - debug:
        var: avatars.stdout_lines
