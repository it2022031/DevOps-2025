---
- name: Install and bootstrap MicroK8s on k8shost
  hosts: k8s
  become: true

  vars:
    microk8s_channel: "1.29/stable"   # ok for 2026, stable
    addons:
      - dns
      - storage
      - ingress
      - metrics-server

  tasks:
    - name: Install snapd (if missing)
      apt:
        name: snapd
        state: present
        update_cache: yes

    - name: Install MicroK8s
      snap:
        name: microk8s
        classic: true
        channel: "{{ microk8s_channel }}"

    - name: Add vagrant user to microk8s group
      user:
        name: vagrant
        groups: microk8s
        append: true

    - name: Ensure ~/.kube exists for vagrant
      file:
        path: /home/vagrant/.kube
        state: directory
        owner: vagrant
        group: vagrant
        mode: "0700"

    - name: Wait for MicroK8s to be ready
      command: microk8s status --wait-ready
      changed_when: false

    - name: Enable MicroK8s addons (dns, storage, ingress, metrics-server)
      command: "microk8s enable {{ addons | join(' ') }}"
      register: enable_out
      changed_when: "'Nothing to do' not in (enable_out.stdout + enable_out.stderr)"

    - name: Show enabled addons output
      debug:
        var: enable_out.stdout_lines

    - name: Create kubectl alias in vagrant .bashrc (optional)
      lineinfile:
        path: /home/vagrant/.bashrc
        line: "alias kubectl='microk8s kubectl'"
        state: present

    - name: Print nodes
      command: microk8s kubectl get nodes -o wide
      register: nodes
      changed_when: false

    - debug:
        var: nodes.stdout_lines
