---
# Preflight + hosts map (ώστε να μην έχουμε conflicts και να λύνουν τα ονόματα backend/db/front)
- import_playbook: ../../../vms/playbooks/preflight_host.yml
- import_playbook: ../../../common/playbooks/hosts_map.yml

# Κοινή προετοιμασία σε όλα τα VMs (δημιουργία ansible tmp για να μην υπάρχουν θέματα με Jenkins/permissions)
- name: Common prep on all VMs (single box via inventory hack)
  hosts: vms
  become: true
  tasks:
    - name: Ensure ansible remote tmp exists
      file:
        path: /tmp/.ansible-jenkins/tmp
        state: directory
        mode: "1777"


- name: Install + configure PostgreSQL on db (cloud-safe)
  hosts: db
  become: true
  vars:
    # Στοιχεία βάσης (user/db)
    db_user: "demo_user"
    db_pass: "demo_pass"
    db_name: "demo_db"
  tasks:
    - name: Install PostgreSQL and contrib
      apt:
        name: [postgresql, postgresql-contrib]
        state: present
        update_cache: yes

    # Βρίσκουμε τη major version από το /etc/postgresql για να χτίσουμε σωστό path στο postgresql.conf
    - name: Detect PostgreSQL major version from /etc/postgresql
      shell: ls -1 /etc/postgresql | sort -n | tail -n 1
      register: pg_major
      changed_when: false

    # Ρυθμίζουμε την Postgres να ακούει μόνο τοπικά (127.0.0.1) για ασφάλεια (DB είναι στο ίδιο VM)
    - name: Configure listen_addresses
      lineinfile:
        path: "/etc/postgresql/{{ pg_major.stdout }}/main/postgresql.conf"
        regexp: '^#?listen_addresses\s*='
        line: "listen_addresses = '127.0.0.1'"
      notify: restart postgres


    - name: Ensure PostgreSQL is running
      service:
        name: postgresql
        state: started
        enabled: yes

    # Τρέχουμε άμεσα τον handler (restart) αν έγιναν αλλαγές στο config
    - name: Apply pending handler actions now
      meta: flush_handlers

    # Δημιουργούμε user αν δεν υπάρχει
    - name: Create PostgreSQL user (safe)
      shell: |
        set -e
        sudo -u postgres psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='{{ db_user }}'" | grep -q 1 \
          || sudo -u postgres psql -c "CREATE USER {{ db_user }} WITH PASSWORD '{{ db_pass }}';"

    # Δημιουργούμε database αν δεν υπάρχει και την ορίζουμε να ανήκει στον user
    - name: Create PostgreSQL database (safe)
      shell: |
        set -e
        sudo -u postgres psql -tAc "SELECT 1 FROM pg_database WHERE datname='{{ db_name }}'" | grep -q 1 \
          || sudo -u postgres psql -c "CREATE DATABASE {{ db_name }} OWNER {{ db_user }};"

    # Δίνουμε δικαιώματα στον user για τη βάση
    - name: Ensure privileges (safe)
      shell: |
        set -e
        sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE {{ db_name }} TO {{ db_user }};"

    # Περιμένουμε να επιβεβαιώσουμε ότι η Postgres ακούει στη 5432 τοπικά
    - name: Wait for PostgreSQL to listen on 5432
      wait_for:
        host: "127.0.0.1"
        port: 5432
        timeout: 60

  handlers:
    - name: restart postgres
      service:
        name: postgresql
        state: restarted


- import_playbook: ../../../vms/playbooks/minio.yml
  vars:
    target_hosts: backend

- import_playbook: ../../../vms/playbooks/mailhog.yml
  vars:
    target_hosts: backend

- import_playbook: ../../../vms/playbooks/java21.yml
  vars:
    target_hosts: backend

- import_playbook: ../../../vms/playbooks/maven.yml
  vars:
    target_hosts: backend


- name: Clone or update DS-2025 repository
  hosts: backend
  become: true
  vars:
    repo_url: "https://github.com/it2022031/DS-2025.git"
    project_dir: "/opt/DS-2025"
    repo_version: "main-branch"
    app_owner: "{{ ansible_user }}"
    version_file: "/opt/DS-2025/VERSION"
  tasks:
    - name: Ensure git is installed
      apt:
        name: git
        state: present
        update_cache: yes
        cache_valid_time: 3600


    - name: Check if repo already exists
      stat:
        path: "{{ project_dir }}/.git"
      register: repo_git

    - name: Clone repository if missing
      git:
        repo: "{{ repo_url }}"
        dest: "{{ project_dir }}"
        version: "{{ repo_version }}"
        update: yes
        force: yes
      when: not repo_git.stat.exists

    # Αν υπάρχει repo, κάνουμε “καθαρό” sync με origin branch
    - name: Force update repo if exists
      shell: |
        set -e
        cd "{{ project_dir }}"
        git fetch --all --prune
        git reset --hard "origin/{{ repo_version }}"
        git clean -fd
      args:
        executable: /bin/bash
      when: repo_git.stat.exists

    # Βάζουμε σωστό owner/group στον φάκελο του project (για build/run χωρίς permission issues)
    - name: Ensure correct ownership
      file:
        path: "{{ project_dir }}"
        owner: "{{ app_owner }}"
        group: "{{ app_owner }}"
        recurse: yes

    - name: Write VERSION file with current commit
      shell: |
        set -e
        cd "{{ project_dir }}"
        git rev-parse --short HEAD > "{{ version_file }}"
      args:
        executable: /bin/bash
      changed_when: false

    - name: Show VERSION
      command: cat {{ version_file }}
      register: ver_out
      changed_when: false

    - debug:
        msg: "DS-2025 VERSION={{ ver_out.stdout }}"

# Ρύθμιση env μεταβλητών backend (DB/Mailhog/MinIO + base URL/CORS)
- import_playbook: ../../../vms/playbooks/backend_env.yml
  vars:
    target_hosts: backend
    db_host: 127.0.0.1
    mail_host: 127.0.0.1
    minio_endpoint: "http://127.0.0.1:9000"
    app_public_base_url: "http://front"   # θα γίνει patch αργότερα με βάση το public IP του front
    cors_allowed_origins: "http://front,http://localhost,http://127.0.0.1"


- name: Build Spring Boot backend JAR
  hosts: backend
  become: true
  vars:
    project_dir: /opt/DS-2025/backend/demo
    jar_dest: /opt/DS-2025/backend/app.jar
    build_user: "{{ ansible_user }}"
  tasks:

    - name: Build backend (skip tests)
      command: mvn -DskipTests package
      args:
        chdir: "{{ project_dir }}"
      become_user: "{{ build_user }}"

    # Βρίσκουμε το “σωστό” jar από το target
    - name: Find built jar (exclude sources/javadoc/original)
      shell: |
        ls -1 {{ project_dir }}/target/*.jar \
          | grep -vE '(-sources|-javadoc|\.original)\.jar$' \
          | head -n 1
      args:
        executable: /bin/bash
      register: built_jar
      changed_when: false

    - name: Fail if no jar found
      fail:
        msg: "Build finished but no suitable JAR found in {{ project_dir }}/target"
      when: built_jar.stdout | length == 0

    # Αντιγράφουμε το jar σε “σταθερό” path (app.jar) για να το χρησιμοποιεί το systemd service
    - name: Copy jar to stable path (app.jar)
      copy:
        src: "{{ built_jar.stdout }}"
        dest: "{{ jar_dest }}"
        remote_src: true
        owner: root
        group: root
        mode: "0755"


- name: Create and run backend systemd service
  hosts: backend
  become: true
  vars:
    app_name: ds2025-backend
    workdir: /opt/DS-2025/backend
    jar_path: /opt/DS-2025/backend/app.jar
    env_file: /opt/DS-2025/backend/app.env
    run_user: "{{ ansible_user }}"
  tasks:
    # Δημιουργούμε systemd unit ώστε το backend να τρέχει σαν service (restart/enable στο boot)
    - name: Create systemd unit file
      copy:
        dest: "/etc/systemd/system/{{ app_name }}.service"
        mode: "0644"
        content: |
          [Unit]
          Description=DS-2025 Spring Boot Backend
          # Περιμένουμε να είναι "online" το network πριν ξεκινήσει η υπηρεσία
          Wants=network-online.target
          After=network-online.target
          [Service]
          # Απλό service: το process τρέχει στο foreground (τυπικό για Spring Boot)
          Type=simple
          # Τρέχει ως μη-root χρήστης
          User={{ run_user }}
          WorkingDirectory={{ workdir }}
          EnvironmentFile={{ env_file }}
          ExecStart=/usr/bin/java -jar {{ jar_path }}
          Restart=always
          RestartSec=3
          # Θεωρούμε "επιτυχή" τον τερματισμό με SIGTERM (143) σε graceful stop
          SuccessExitStatus=143

          [Install]
          # Επιτρέπει enable για αυτόματη εκκίνηση στο boot
          WantedBy=multi-user.target

    # Reload του systemd για να “δει” το νέο/ενημερωμένο unit file
    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start backend service
      systemd:
        name: "{{ app_name }}"
        enabled: yes
        state: started

    - name: Wait for backend port to be open
      wait_for:
        host: 127.0.0.1
        port: 8080
        state: started
        timeout: 120

- name: Ensure Node.js/npm available on front
  hosts: front
  become: true
  tasks:
    # Εγκατάσταση Node.js/npm στο front VM για build/serve του Vue frontend
    - name: Install nodejs + npm (system)
      apt:
        name: [nodejs, npm]
        state: present
        update_cache: yes
        cache_valid_time: 3600


- import_playbook: ../../../vms/playbooks/frontend_env.yml
  vars:
    target_hosts: front

# Αφαιρούμε/διορθώνουμε τιμές που έχουν μείνει σε localhost ώστε το frontend να λειτουργεί σωστά στο VM
- import_playbook: ../../../vms/playbooks/frontend_strip_localhost.yml
  vars:
    target_hosts: front

- import_playbook: ../../../vms/playbooks/frontend_build.yml
  vars:
    target_hosts: front

- name: Create and run frontend systemd service
  hosts: front
  become: true
  vars:
    app_name: ds2025-frontend
    run_user: "{{ ansible_user }}"
    frontend_dir: "/opt/DS-2025/frontend/vue-argon-design-system-master"
    front_port: 8081
  tasks:
    # Δημιουργούμε systemd unit για το frontend ώστε να σερβίρει το built dist σαν υπηρεσία:
    - name: Create systemd unit for frontend (serve dist via npx serve)
      copy:
        dest: "/etc/systemd/system/{{ app_name }}.service"
        mode: "0644"
        content: |
          [Unit]
          Description=DS-2025 Frontend (serve dist)
          # Περιμένουμε να είναι "online" το network πριν ξεκινήσει η υπηρεσία
          Wants=network-online.target
          After=network-online.target

          [Service]
          Type=simple
          # Τρέχει ως μη-root χρήστης
          User={{ run_user }}
          WorkingDirectory={{ frontend_dir }}
          # Εκκίνηση static server για το dist:
          # -s dist: SPA mode (σωστό routing)
          # -l: port που θα ακούει το frontend
          ExecStart=/usr/bin/env bash -lc 'cd "{{ frontend_dir }}" && npx --yes serve -s dist -l {{ front_port }}'
          Restart=always
          RestartSec=3

          [Install]
          # Επιτρέπει enable για αυτόματη εκκίνηση στο boot
          WantedBy=multi-user.target


    # Reload systemd ώστε να διαβαστεί το νέο unit file
    - name: Reload systemd
      systemd:
        daemon_reload: true

    - name: Enable and start frontend service
      systemd:
        name: "{{ app_name }}"
        enabled: true
        state: started

    - name: Wait for frontend port
      wait_for:
        host: 127.0.0.1
        port: "{{ front_port }}"
        timeout: 90


- import_playbook: ../../../vms/playbooks/nginx_install.yml
  vars:
    target_hosts: front

- import_playbook: ../../../vms/playbooks/nginx_site.yml
  vars:
    target_hosts: front
    nginx_site: ds2025-front
    upstream_host: 127.0.0.1
    upstream_port: 8081
    enable_api_proxy: true
    api_prefix: "/api/"
    api_upstream_host: "127.0.0.1"
    api_upstream_port: 8080

- import_playbook: ../../../vms/playbooks/nginx_restart.yml
  vars:
    target_hosts: front


- name: Patch backend public URL + CORS for online (inventory-based)
  hosts: backend
  become: true
  vars:
    public_base_url: "http://{{ hostvars['front'].ansible_host }}"
  tasks:
    - name: Patch backend env file (APP_PUBLIC_BASE_URL)
      lineinfile:
        path: /opt/DS-2025/backend/app.env
        # Αντικαθιστούμε τη γραμμή που ξεκινά με APP_PUBLIC_BASE_URL=
        regexp: '^APP_PUBLIC_BASE_URL='
        # Θέτουμε τη σωστή τιμή με βάση το public IP/host του front
        line: "APP_PUBLIC_BASE_URL={{ public_base_url }}"

    - name: Patch backend env file (APP_FRONTEND_URL)
      lineinfile:
        path: /opt/DS-2025/backend/app.env
        regexp: '^APP_FRONTEND_URL='
        line: "APP_FRONTEND_URL={{ public_base_url }}"

    - name: Patch backend env file (CORS_ALLOWED_ORIGINS)
      lineinfile:
        path: /opt/DS-2025/backend/app.env
        regexp: '^CORS_ALLOWED_ORIGINS='
        line: >
          CORS_ALLOWED_ORIGINS={{ public_base_url }},
          http://localhost,
          http://127.0.0.1

    # Restart του backend για να εφαρμοστούν οι αλλαγές στο env file
    - name: Restart backend
      service:
        name: ds2025-backend
        state: restarted

- name: Healthcheck
  hosts: backend
  become: true
  tasks:
    # Έλεγχος ότι η βάση ακούει τοπικά στη 5432
    - name: Check DB local
      shell: nc -vz -w 2 127.0.0.1 5432
      changed_when: false

    # Έλεγχος ότι το backend απαντάει HTTP (200/302 κ.λπ.) στο localhost:8080
    - name: Check backend local
      shell: curl -s -o /dev/null -w "%{http_code}\n" http://127.0.0.1:8080/ || true
      changed_when: false
