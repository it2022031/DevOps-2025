---
- name: Install and bootstrap MicroK8s on k8shost
  hosts: k8s_nodes
  become: true

  vars:
    microk8s_channel: "1.29/stable"
    addons:
      - dns
      - storage
      - ingress
      - metrics-server

  tasks:
    - name: Install snapd (if missing)
      apt:
        name: snapd
        state: present
        update_cache: yes

    - name: Ensure snapd service is running
      service:
        name: snapd
        state: started
        enabled: true

    - name: Wait for snap seeding to finish (prevents "too early")
      command: sudo snap wait system seed.loaded
      changed_when: false

    - name: Wait for snapd to be ready (seeding)
      shell: |
        set -e
        # wait up to ~2 minutes for snapd seeding to complete
        for i in $(seq 1 60); do
          if snap list >/dev/null 2>&1; then
            echo "snapd is ready"
            exit 0
          fi
          sleep 2
        done
        echo "snapd not ready in time"
        snap changes || true
        exit 1
      args:
        executable: /bin/bash
      changed_when: false

    - name: Install MicroK8s via snap (idempotent + retries)
      shell: |
        set -e
        if ! snap list | awk '{print $1}' | grep -qx microk8s; then
          snap install microk8s --classic --channel="{{ microk8s_channel }}"
        else
          echo "microk8s already installed"
        fi
      args:
        executable: /bin/bash
      register: install_out
      retries: 10
      delay: 6
      until: install_out.rc == 0
      changed_when: false

    - name: Add vagrant user to microk8s group
      user:
        name: vagrant
        groups: microk8s
        append: true

    - name: Ensure ~/.kube exists for vagrant
      file:
        path: /home/vagrant/.kube
        state: directory
        owner: vagrant
        group: vagrant
        mode: "0700"

    - name: Wait for MicroK8s to be ready
      command: microk8s status --wait-ready
      changed_when: false

    - name: Enable MicroK8s addons (safe rerun)
      shell: |
        set -e
        for a in {{ addons | join(' ') }}; do
          if sudo microk8s status | grep -q "^\s*$a\s\+.*enabled"; then
            echo "addon $a already enabled"
          else
            echo "enabling addon $a"
            sudo microk8s enable "$a"
          fi
        done
      args:
        executable: /bin/bash
      changed_when: false

    - name: Write kubeconfig for vagrant (optional)
      shell: |
        set -e
        sudo microk8s config > /home/vagrant/.kube/config
        chown vagrant:vagrant /home/vagrant/.kube/config
        chmod 600 /home/vagrant/.kube/config
      args:
        executable: /bin/bash
      changed_when: false

    - name: Create kubectl alias in vagrant .bashrc (optional)
      lineinfile:
        path: /home/vagrant/.bashrc
        line: "alias kubectl='microk8s kubectl'"
        state: present

    - name: Print nodes
      command: sudo microk8s kubectl get nodes -o wide
      register: nodes
      changed_when: false

    - debug:
        var: nodes.stdout_lines
