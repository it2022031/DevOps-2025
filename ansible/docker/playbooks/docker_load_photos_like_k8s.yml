---
- name: Load photos in Docker from /seed/load_photos.sql (k8s-like)
  hosts: docker_nodes
  become: true

  vars:
    compose_dir: "/vagrant/ansible/docker"
    db_name: "demo_db"
    db_user: "demo_user"
    load_sql_in_container: "/seed/load_photos.sql"

  tasks:
    - name: Bring stack up
      shell: |
        set -e
        cd "{{ compose_dir }}"
        /usr/local/bin/docker-compose up -d
      args:
        executable: /bin/bash

    - name: Wait until db is healthy
      shell: |
        set -e
        cd "{{ compose_dir }}"
        for i in $(seq 1 60); do
          if /usr/local/bin/docker-compose ps | grep -E "db" | grep -q "healthy"; then exit 0; fi
          sleep 2
        done
        /usr/local/bin/docker-compose ps
        exit 1
      args:
        executable: /bin/bash

    - name: Verify load_photos.sql exists inside db container
      shell: |
        set -e
        cd "{{ compose_dir }}"
        /usr/local/bin/docker-compose exec -T db sh -lc 'test -f "{{ load_sql_in_container }}" && echo OK'
      args:
        executable: /bin/bash

    - name: Run load_photos.sql inside db container
      shell: |
        set -e
        cd "{{ compose_dir }}"
        /usr/local/bin/docker-compose exec -T db sh -lc \
          'psql -U "{{ db_user }}" -d "{{ db_name }}" -v ON_ERROR_STOP=1 -f "{{ load_sql_in_container }}"'
      args:
        executable: /bin/bash
