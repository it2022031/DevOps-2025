---
- name: Configure frontend environment variables (.env / .env.production)
  hosts: front
  become: true
  gather_facts: true

  vars:
    frontend_dir: "/opt/DS-2025/frontend/vue-argon-design-system-master"

    backend_base_url: "/api"

  tasks:
    - name: Fail if frontend directory does not exist
      stat:
        path: "{{ frontend_dir }}"
      register: fe_dir

    - name: Show frontend_dir exists
      debug:
        msg: "frontend_dir={{ frontend_dir }} exists={{ fe_dir.stat.exists }}"

    - name: Fail early if missing
      fail:
        msg: "Frontend dir missing: {{ frontend_dir }}"
      when: not fe_dir.stat.exists

    # Auto-detect app owner (vagrant if exists, else ubuntu, else ansible_user)
    - name: Detect app_owner
      set_fact:
        app_owner: >-
          {{
            'vagrant' if (ansible_facts.getent_passwd['vagrant'] is defined)
            else ('ubuntu' if (ansible_facts.getent_passwd['ubuntu'] is defined) else ansible_user)
          }}

    - name: Ensure frontend dir owned by app_owner (avoid EACCES)
      file:
        path: "{{ frontend_dir }}"
        owner: "{{ app_owner }}"
        group: "{{ app_owner }}"
        recurse: true

    # Vue CLI uses VUE_APP_* vars (NOT VITE_*)
    - name: Write .env (Vue CLI)
      copy:
        dest: "{{ frontend_dir }}/.env"
        owner: "{{ app_owner }}"
        group: "{{ app_owner }}"
        mode: "0644"
        content: |
          VUE_APP_API_BASE_URL={{ backend_base_url }}

    - name: Write .env.production (Vue CLI)
      copy:
        dest: "{{ frontend_dir }}/.env.production"
        owner: "{{ app_owner }}"
        group: "{{ app_owner }}"
        mode: "0644"
        content: |
          VUE_APP_API_BASE_URL={{ backend_base_url }}

    - name: Print env files (debug)
      shell: |
        set -e
        echo "=== .env ==="
        cat "{{ frontend_dir }}/.env"
        echo "=== .env.production ==="
        cat "{{ frontend_dir }}/.env.production"
      args:
        executable: /bin/bash
      register: env_out
      changed_when: false

    - debug:
        var: env_out.stdout_lines
