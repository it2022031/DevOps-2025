---
- name: Configure backend environment variables
  hosts: backend
  become: true

  vars:
    env_dir: /opt/DS-2025/backend
    env_file: /opt/DS-2025/backend/app.env

    db_host: db
    db_port: 5432
    db_name: demo_db
    db_user: demo_user
    db_pass: demo_pass

    spring_profile: prod

    mail_host: backend
    mail_port: 1025

    minio_endpoint: "http://backend:9000"
    minio_access_key: minioadmin
    minio_secret_key: minioadmin123

    app_public_base_url: "http://127.0.0.1:8090"
    cors_allowed_origins: "http://front,http://localhost:8090,http://127.0.0.1:8090"

  tasks:
    - name: Ensure backend env directory exists
      file:
        path: "{{ env_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    # Γράφουμε το αρχείο app.env με όλες τις μεταβλητές περιβάλλοντος του backend
    # Το copy module είναι idempotent (γράφει μόνο αν αλλάξει κάτι)
    - name: Write backend env file (idempotent)
      copy:
        dest: "{{ env_file }}"
        owner: root
        group: root
        mode: "0640"
        content: |
          SPRING_PROFILES_ACTIVE={{ spring_profile }}

          SPRING_DATASOURCE_URL=jdbc:postgresql://{{ db_host }}:{{ db_port }}/{{ db_name }}
          SPRING_DATASOURCE_USERNAME={{ db_user }}
          SPRING_DATASOURCE_PASSWORD={{ db_pass }}

          CORS_ALLOWED_ORIGINS={{ cors_allowed_origins }}

          SPRING_MAIL_HOST={{ mail_host }}
          SPRING_MAIL_PORT={{ mail_port }}

          MINIO_ENDPOINT={{ minio_endpoint }}
          MINIO_ACCESS_KEY={{ minio_access_key }}
          MINIO_SECRET_KEY={{ minio_secret_key }}

          APP_PUBLIC_BASE_URL={{ app_public_base_url }}
          APP_FRONTEND_URL={{ app_public_base_url }}
      register: env_written

    - name: Show env file location
      debug:
        msg: "Backend env file written at {{ env_file }}"

    # Παίρνουμε πληροφορίες για τα services του συστήματος
    # Εκτελείται μόνο αν άλλαξε το env αρχείο
    - name: Gather service facts
      service_facts:
      when: env_written.changed

    # Κάνουμε restart το backend service ΜΟΝΟ αν:
    # - άλλαξε το env αρχείο
    # - υπάρχει ήδη το systemd service backend
    - name: Restart backend service if present and env changed
      service:
        name: ds2025-backend
