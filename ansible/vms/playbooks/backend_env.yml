---
- name: Configure backend environment variables
  hosts: backend
  become: true

  vars:
    env_dir: /opt/DS-2025/backend
    env_file: /opt/DS-2025/backend/app.env

    db_host: "{{ hostvars['db'].db_private_ip | default(hostvars['db'].ansible_host) }}"
    db_port: 5432
    db_name: demo_db
    db_user: demo_user
    db_pass: demo_pass

    spring_profile: prod

    mail_host: 127.0.0.1
    mail_port: 1025

    minio_endpoint: "http://127.0.0.1:9000"
    minio_access_key: minioadmin
    minio_secret_key: minioadmin123

    app_public_base_url: "http://127.0.0.1:8090"
    cors_allowed_origins: "http://127.0.0.1:8090,http://localhost:8090"

  tasks:
    - name: Ensure backend env directory exists
      file:
        path: "{{ env_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Write backend env file (idempotent)
      copy:
        dest: "{{ env_file }}"
        owner: root
        group: root
        mode: "0640"
        content: |
          SPRING_PROFILES_ACTIVE={{ spring_profile }}

          SPRING_DATASOURCE_URL=jdbc:postgresql://{{ db_host }}:{{ db_port }}/{{ db_name }}
          SPRING_DATASOURCE_USERNAME={{ db_user }}
          SPRING_DATASOURCE_PASSWORD={{ db_pass }}

          CORS_ALLOWED_ORIGINS={{ cors_allowed_origins }}

          SPRING_MAIL_HOST={{ mail_host }}
          SPRING_MAIL_PORT={{ mail_port }}

          MINIO_ENDPOINT={{ minio_endpoint }}
          MINIO_ACCESS_KEY={{ minio_access_key }}
          MINIO_SECRET_KEY={{ minio_secret_key }}

          APP_PUBLIC_BASE_URL={{ app_public_base_url }}
          APP_FRONTEND_URL={{ app_public_base_url }}
      register: env_written

    - name: Show env file location
      debug:
        msg: "Backend env file written at {{ env_file }}"

    # âœ… Restart only if:
    #  - env file changed AND
    #  - service exists already (fresh install won't have it yet)
    - name: Gather service facts
      service_facts:
      when: env_written.changed

    - name: Restart backend service if present and env changed
      service:
        name: ds2025-backend
        state: restarted
      when:
        - env_written.changed
        - "'ds2025-backend.service' in ansible_facts.services"
