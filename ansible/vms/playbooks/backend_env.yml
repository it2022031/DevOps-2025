---
- name: Configure backend environment variables
  hosts: backend
  become: true

  vars:
    env_dir: /opt/DS-2025/backend
    env_file: /opt/DS-2025/backend/app.env

    db_host: "{{ hostvars['db'].db_private_ip | default(hostvars['db'].ansible_host) }}"
    db_port: 5432
    db_name: demo_db
    db_user: demo_user
    db_pass: demo_pass

    spring_profile: prod

    # MailHog runs on backend VM (same host)
    mail_host: 127.0.0.1
    mail_port: 1025

    # MinIO runs on backend VM (same host)
    minio_endpoint: "http://127.0.0.1:9000"
    minio_access_key: minioadmin
    minio_secret_key: minioadmin123

    # ✅ Public URL (frontend – what the user opens in browser)
    app_public_base_url: "http://127.0.0.1:8090"

    # ✅ CORS: frontend origins allowed to call backend
    cors_allowed_origins: "http://127.0.0.1:8090,http://localhost:8090"

  tasks:
    - name: Ensure backend env directory exists
      file:
        path: "{{ env_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Write backend env file (idempotent)
      copy:
        dest: "{{ env_file }}"
        owner: root
        group: root
        mode: "0640"
        content: |
          # Spring profile
          SPRING_PROFILES_ACTIVE={{ spring_profile }}

          # Database
          SPRING_DATASOURCE_URL=jdbc:postgresql://{{ db_host }}:{{ db_port }}/{{ db_name }}
          SPRING_DATASOURCE_USERNAME={{ db_user }}
          SPRING_DATASOURCE_PASSWORD={{ db_pass }}

          # CORS (frontend origins)
          CORS_ALLOWED_ORIGINS={{ cors_allowed_origins }}

          # MailHog (SMTP)
          SPRING_MAIL_HOST={{ mail_host }}
          SPRING_MAIL_PORT={{ mail_port }}

          # MinIO
          MINIO_ENDPOINT={{ minio_endpoint }}
          MINIO_ACCESS_KEY={{ minio_access_key }}
          MINIO_SECRET_KEY={{ minio_secret_key }}

          # Activation links in emails
          APP_PUBLIC_BASE_URL={{ app_public_base_url }}

          # Redirect target after activation
          APP_FRONTEND_URL={{ app_public_base_url }}
      notify: restart backend

    - name: Show env file location
      debug:
        msg: "Backend env file written at {{ env_file }}"

  handlers:
    - name: restart backend
      service:
        name: ds2025-backend
        state: restarted
