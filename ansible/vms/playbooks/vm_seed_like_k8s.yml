---
- name: Seed PostgreSQL on VMs from /vagrant/data/sqlData/test_dedomena.sql
  hosts: backend_nodes
  become: true

  vars:
    db_host: "{{ hostvars['db'].db_private_ip }}"
    db_port: 5432
    db_name: demo_db
    db_user: demo_user
    db_pass: demo_pass
    seed_sql: /vagrant/data/sqlData/test_dedomena.sql

  tasks:
    - name: Ensure psql client exists on backend
      apt:
        name: postgresql-client
        state: present
        update_cache: yes

    - name: Ensure seed SQL exists on backend (synced)
      stat:
        path: "{{ seed_sql }}"
      register: s

    - name: Fail if seed SQL missing
      fail:
        msg: "Missing {{ seed_sql }} (expected in /vagrant/data/sqlData/test_dedomena.sql)"
      when: not s.stat.exists

    - name: Wait for DB reachable
      wait_for:
        host: "{{ db_host }}"
        port: "{{ db_port }}"
        timeout: 60

    - name: Run seed SQL
      shell: |
        set -euo pipefail
        export PGPASSWORD='{{ db_pass }}'
        psql -v ON_ERROR_STOP=1 -h '{{ db_host }}' -p '{{ db_port }}' -U '{{ db_user }}' -d '{{ db_name }}' -f '{{ seed_sql }}'
      args:
        executable: /bin/bash
