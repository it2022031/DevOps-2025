# ansible/vms/playbooks/postgres.yml
---
- name: Install and configure PostgreSQL on db server
  hosts: db
  become: true

  vars:
    pg_version: 14

    db_name: demo_db
    db_user: demo_user
    db_pass: demo_pass

    # ✅ IMPORTANT:
    # Set this to match your VM subnet.
    # - Vagrant host-only default: 192.168.56.0/24
    # - Your old intnet setup:     10.10.10.0/24
    #
    # You can override from inventory:
    #   [all:vars]
    #   allowed_cidr=192.168.56.0/24
    #
    allowed_cidr: "{{ allowed_cidr | default('192.168.56.0/24') }}"

  tasks:
    - name: Install PostgreSQL and dependencies
      apt:
        name:
          - postgresql
          - postgresql-contrib
          - python3-psycopg2
        state: present
        update_cache: yes

    - name: Ensure PostgreSQL is running
      service:
        name: postgresql
        state: started
        enabled: yes

    - name: Configure listen_addresses
      lineinfile:
        path: "/etc/postgresql/{{ pg_version }}/main/postgresql.conf"
        regexp: "^#?listen_addresses\\s*="
        line: "listen_addresses = '*'"
      notify: restart postgres

    - name: Allow network connections in pg_hba.conf (app subnet)
      lineinfile:
        path: "/etc/postgresql/{{ pg_version }}/main/pg_hba.conf"
        # matches the exact line for the current allowed_cidr (idempotent)
        regexp: "^host\\s+all\\s+all\\s+{{ allowed_cidr | regex_escape() }}\\s+md5\\s*$"
        line: "host all all {{ allowed_cidr }} md5"
        insertafter: EOF
        create: no
      notify: restart postgres

    # ✅ Ensure config changes applied BEFORE creating users/dbs
    - name: Apply pending handler actions now
      meta: flush_handlers

    - name: Create PostgreSQL user
      become_user: postgres
      postgresql_user:
        name: "{{ db_user }}"
        password: "{{ db_pass }}"
        encrypted: yes

    - name: Create PostgreSQL database
      become_user: postgres
      postgresql_db:
        name: "{{ db_name }}"
        owner: "{{ db_user }}"

    - name: Wait for PostgreSQL to listen on 5432
      wait_for:
        host: "127.0.0.1"
        port: 5432
        state: started
        timeout: 20

    - name: Verify PostgreSQL is listening on TCP 5432
      shell: "ss -lntp | grep ':5432' || true"
      register: pg_listen_check
      changed_when: false

    - name: Show listening check
      debug:
        var: pg_listen_check.stdout_lines

  handlers:
    - name: restart postgres
      service:
        name: postgresql
        state: restarted
