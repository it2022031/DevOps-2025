---
- name: Install and configure PostgreSQL on db server
  hosts: db
  become: true

  vars:
    pg_version: "14"
    allowed_cidr_default: "192.168.56.0/24"

    # DB credentials (override via inventory/group_vars if needed)
    db_user: "demo_user"
    db_pass: "demo_pass"
    db_name: "demo_db"
    db_port: 5432

  handlers:
    - name: restart postgres
      service:
        name: postgresql
        state: restarted

  tasks:
    - name: Install PostgreSQL and dependencies
      apt:
        name:
          - postgresql
          - postgresql-contrib
        state: present
        update_cache: yes

    - name: Ensure PostgreSQL is running
      service:
        name: postgresql
        state: started
        enabled: yes

    - name: Configure listen_addresses
      lineinfile:
        path: "/etc/postgresql/{{ pg_version }}/main/postgresql.conf"
        regexp: '^#?listen_addresses\s*='
        line: "listen_addresses = '*'"
      notify: restart postgres

    - name: Allow network connections in pg_hba.conf (app subnet)
      lineinfile:
        path: "/etc/postgresql/{{ pg_version }}/main/pg_hba.conf"
        regexp: "^host\\s+all\\s+all\\s+{{ (allowed_cidr | default(allowed_cidr_default)) | regex_escape() }}\\s+md5\\s*$"
        line: "host all all {{ allowed_cidr | default(allowed_cidr_default) }} md5"
        insertafter: EOF
      notify: restart postgres

    - name: Apply pending handler actions now
      meta: flush_handlers

    # ---- Safe user/db creation (avoids become_user tmp chown issues) ----
    - name: Create PostgreSQL user (psql safe)
      shell: |
        set -e
        sudo -u postgres psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='{{ db_user }}'" | grep -q 1 \
          || sudo -u postgres psql -c "CREATE USER {{ db_user }} WITH PASSWORD '{{ db_pass }}';"

    - name: Create PostgreSQL database (psql safe)
      shell: |
        set -e
        sudo -u postgres psql -tAc "SELECT 1 FROM pg_database WHERE datname='{{ db_name }}'" | grep -q 1 \
          || sudo -u postgres psql -c "CREATE DATABASE {{ db_name }} OWNER {{ db_user }};"

    - name: Ensure privileges (psql safe)
      shell: |
        set -e
        sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE {{ db_name }} TO {{ db_user }};"

    - name: Wait for PostgreSQL to listen on 5432
      wait_for:
        host: "127.0.0.1"
        port: 5432
        timeout: 60

    - name: Verify PostgreSQL is listening on TCP 5432
      shell: "ss -lntp | grep ':5432' || true"
      register: pg_listen_check

    - name: Show listening check
      debug:
        var: pg_listen_check.stdout_lines
