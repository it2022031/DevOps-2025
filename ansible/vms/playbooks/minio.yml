---
- name: Install and configure MinIO on backend (native)
  hosts: backend
  become: true

  vars:
    minio_user: minio
    minio_group: minio
    minio_data_dir: /var/lib/minio
    minio_bin: /usr/local/bin/minio
    minio_console_port: 9001
    minio_api_port: 9000

    minio_root_user: minioadmin
    minio_root_password: minioadmin123

  tasks:
    - name: Create minio group
      group:
        name: "{{ minio_group }}"
        system: true

    - name: Create minio user
      user:
        name: "{{ minio_user }}"
        group: "{{ minio_group }}"
        system: true
        shell: /usr/sbin/nologin
        create_home: false

    - name: Create data directory
      file:
        path: "{{ minio_data_dir }}"
        state: directory
        owner: "{{ minio_user }}"
        group: "{{ minio_group }}"
        mode: "0755"

    - name: Download MinIO server binary
      get_url:
        url: "https://dl.min.io/server/minio/release/linux-amd64/minio"
        dest: "{{ minio_bin }}"
        mode: "0755"

    - name: Create MinIO environment file
      copy:
        dest: /etc/default/minio
        mode: "0640"
        owner: root
        group: "{{ minio_group }}"
        content: |
          MINIO_ROOT_USER={{ minio_root_user }}
          MINIO_ROOT_PASSWORD={{ minio_root_password }}
          MINIO_VOLUMES={{ minio_data_dir }}
          MINIO_OPTS=--console-address :{{ minio_console_port }}

    # Φτιάχνουμε systemd service για να τρέχει μόνιμα και να ξεκινά στο boot
    - name: Create systemd unit for MinIO
      copy:
        dest: /etc/systemd/system/minio.service
        mode: "0644"
        content: |
          [Unit]
          Description=MinIO
          # Ξεκίνα αφού είναι έτοιμο το δίκτυο
          After=network-online.target
          Wants=network-online.target

          [Service]
          # Τρέχει ως minio χρήστης (όχι root)
          User={{ minio_user }}
          Group={{ minio_group }}
          # Φορτώνει τις μεταβλητές από /etc/default/minio
          EnvironmentFile=/etc/default/minio
          # Εκκίνηση MinIO server με volume + console options
          ExecStart={{ minio_bin }} server $MINIO_VOLUMES $MINIO_OPTS
          # Αν πέσει, ξανασηκώνεται
          Restart=always
          # Αυξάνουμε το όριο open files (χρήσιμο για object storage)
          LimitNOFILE=65536

          [Install]
          WantedBy=multi-user.target
      notify: restart minio

    - name: Reload systemd
      systemd:
        daemon_reload: true

    - name: Enable and start MinIO
      service:
        name: minio
        state: started
        enabled: true

  handlers:
    - name: restart minio
      service:
        name: minio
        state: restarted
