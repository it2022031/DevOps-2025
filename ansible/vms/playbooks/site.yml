---
# 0) Έλεγχοι στο host πριν ξεκινήσουμε
- import_playbook: preflight_host.yml

# Mapping hostnames (backend/db/front) ώστε να “λύνουν” σωστά μέσα στα VMs
- import_playbook: ../../common/playbooks/hosts_map.yml

# 1) Κοινή προετοιμασία σε όλα τα VMs
- name: Common prep on all VMs
  hosts: vms
  become: true
  tasks:
    # Φτιάχνουμε tmp directory για να μην έχει θέματα το Ansible/Jenkins με temporary files
    - name: Ensure ansible remote tmp exists
      file:
        path: /tmp/.ansible-jenkins/tmp
        state: directory
        mode: "1777"

# 2) Εγκατάσταση/ρύθμιση PostgreSQL στη DB VM
- import_playbook: postgres.yml

# 3) Supporting services στο backend VM (MinIO + MailHog)
- import_playbook: minio.yml
- import_playbook: mailhog.yml

# 4) Προαπαιτούμενα backend + κατέβασμα κώδικα
- import_playbook: java21.yml
- import_playbook: maven.yml

- import_playbook: clone_ds2025.yml
  vars:
    target_hosts: backend

# 5) Backend runtime: env, build jar, και systemd service
- import_playbook: backend_env.yml
- import_playbook: build_backend.yml
- import_playbook: backend_service.yml

# 6) Nginx στο backend (reverse proxy :80 -> :8080)
- import_playbook: nginx_install.yml
  vars:
    target_hosts: backend

- import_playbook: nginx_site.yml
  vars:
    target_hosts: backend
    nginx_site: ds2025
    upstream_host: 127.0.0.1
    upstream_port: 8080
    enable_api_proxy: false

- import_playbook: nginx_restart.yml
  vars:
    target_hosts: backend

# 7) Προαπαιτούμενα frontend
- import_playbook: nvm_install.yml
- import_playbook: nvm_verify.yml

- import_playbook: clone_ds2025.yml
  vars:
    target_hosts: front

# 8) Frontend: env, καθάρισμα localhost URLs, build, και systemd service (serve στο :8081)
- import_playbook: frontend_env.yml
- import_playbook: frontend_strip_localhost.yml
- import_playbook: frontend_build.yml
- import_playbook: frontend_service.yml

# 9) Nginx στο front (reverse proxy :80 -> :8081 και /api -> backend:8080)
- import_playbook: nginx_install.yml
  vars:
    target_hosts: front

- import_playbook: nginx_site.yml
  vars:
    target_hosts: front
    nginx_site: ds2025-front
    upstream_host: 127.0.0.1
    upstream_port: 8081
    enable_api_proxy: true
    api_prefix: "/api/"
    api_upstream_host: "backend"
    api_upstream_port: 8080

- import_playbook: nginx_restart.yml
  vars:
    target_hosts: front


# 10) Τελικοί έλεγχοι (DB, connectivity, ports, κτλ)
- import_playbook: healthcheck.yml
