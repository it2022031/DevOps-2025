---
- name: Build frontend (npm install + npm run build)
  hosts: front
  become: true
  gather_facts: true

  vars:
    frontend_dir: "/opt/DS-2025/frontend/vue-argon-design-system-master"

  tasks:
    - name: Fail if frontend directory does not exist
      stat:
        path: "{{ frontend_dir }}"
      register: fe_dir

    - name: Fail early if missing
      fail:
        msg: "Frontend dir missing: {{ frontend_dir }}"
      when: not fe_dir.stat.exists

    # Βρίσκουμε αυτόματα ποιος χρήστης θα κάνει το build
    # (αν υπάρχει vagrant τον προτιμάμε, αλλιώς ubuntu, αλλιώς ansible_user)
    - name: Detect build_user
      set_fact:
        build_user: >-
          {{
            'vagrant' if (ansible_facts.getent_passwd['vagrant'] is defined)
            else ('ubuntu' if (ansible_facts.getent_passwd['ubuntu'] is defined) else ansible_user)
          }}

    # Βάζουμε ownership στον build_user για να μην έχουμε permission errors (EACCES)
    - name: Ensure frontend dir owned by build_user (avoid EACCES)
      file:
        path: "{{ frontend_dir }}"
        owner: "{{ build_user }}"
        group: "{{ build_user }}"
        recurse: true

    # Εγκαθιστούμε nodejs + npm από apt σαν fallback (ώστε να υπάρχει npm)
    - name: Ensure nodejs and npm exist (fallback)
      apt:
        name:
          - nodejs
          - npm
        state: present
        update_cache: yes
        cache_valid_time: 3600

    # Κάνουμε npm install / npm ci και μετά npm run build
    # Αν υπάρχει NVM, το χρησιμοποιούμε (αλλιώς πάμε με το system node)
    - name: Install deps + build (use NVM if available, else system node)
      become_user: "{{ build_user }}"
      shell: |
        set -euo pipefail
        cd "{{ frontend_dir }}"

        # Προσπαθούμε να φορτώσουμε NVM αν υπάρχει
        export NVM_DIR="$HOME/.nvm"
        if [ -s "$NVM_DIR/nvm.sh" ]; then
          . "$NVM_DIR/nvm.sh"
          nvm use default || true
        fi

        # Αν υπάρχει package-lock.json προτιμάμε npm ci (πιο σταθερό)
        if [ -f package-lock.json ]; then
          npm ci || npm install
        else
          npm install
        fi

        # Build του frontend (δημιουργεί τον φάκελο dist/)
        npm run build
      args:
        executable: /bin/bash

    # Ελέγχουμε ότι όντως δημιουργήθηκε το dist/
    - name: Verify dist exists
      stat:
        path: "{{ frontend_dir }}/dist"
      register: dist_dir

    # Αν δεν δημιουργήθηκε, σταματάμε με σφάλμα
    - name: Fail if dist missing
      fail:
        msg: "dist/ not created"
      when: not dist_dir.stat.exists
