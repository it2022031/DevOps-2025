---
- name: Load photos on DB VM using /vagrant/data/sqlData (no copy, k8s-like)
  hosts: db_nodes

  become: true

  vars:
    db_name: demo_db
    load_sql: /vagrant/data/sqlData/load_photos.sql
    photos_dir: /vagrant/data/sqlData/photos

  tasks:
    - name: Ensure load_photos.sql exists (synced)
      stat:
        path: "{{ load_sql }}"
      register: s1

    - name: Fail if load_photos.sql missing
      fail:
        msg: "Missing {{ load_sql }} (expected /vagrant/data/sqlData/load_photos.sql)"
      when: not s1.stat.exists

    - name: Ensure photos dir exists (synced)
      stat:
        path: "{{ photos_dir }}"
      register: s2

    - name: Fail if photos dir missing
      fail:
        msg: "Missing {{ photos_dir }} (expected /vagrant/data/sqlData/photos/)"
      when: not s2.stat.exists

    # Φτιάχνουμε σταθερό path (/photos) όπως το περιμένει το SQL script
    # Χρησιμοποιούμε symlinks για να μη χρειάζεται αντιγραφή αρχείων
    - name: Prepare /photos as stable path expected by SQL
      shell: |
        set -e

        rm -rf /photos
        mkdir -p /photos

        # Πρέπει να υπάρχει ο φάκελος avatar_photos
        test -d "{{ photos_dir }}/avatar_photos"

        # Ο φάκελος property_photos μπορεί να υπάρχει και με trailing space (λάθος όνομα)
        if [ -d "{{ photos_dir }}/property_photos" ]; then
          PROP_DIR="{{ photos_dir }}/property_photos"
        elif [ -d "{{ photos_dir }}/property_photos " ]; then
          PROP_DIR="{{ photos_dir }}/property_photos "
        else
          echo "No property_photos folder found under {{ photos_dir }}"
          exit 1
        fi

        # Δημιουργούμε symlinks ώστε το SQL να βρίσκει πάντα /photos/...
        ln -s "{{ photos_dir }}/avatar_photos" /photos/avatar_photos
        ln -s "$PROP_DIR" /photos/property_photos

        echo "Symlinks:"
        ls -la /photos

        # Μικρός έλεγχος ότι υπάρχουν δείγματα αρχείων
        echo "Check sample files:"
        test -f "/photos/avatar_photos/f1.jpg"
        test -f "/photos/property_photos/Lake Villa 1.jpg"
      args:
        executable: /bin/bash

    - name: Run load_photos.sql as postgres (workdir /tmp to avoid /home/vagrant permission)
      shell: |
        set -euo pipefail
        sudo -u postgres bash -lc 'cd /tmp && psql -d "{{ db_name }}" -v ON_ERROR_STOP=1 -f "{{ load_sql }}"'
      args:
        executable: /bin/bash

    - name: Sanity check property_photos count
      shell: |
        set -e
        sudo -u postgres psql -d "{{ db_name }}" -c "select count(*) as property_photos from property_photos;"
      args:
        executable: /bin/bash
      register: prop_count
      changed_when: false

    - debug:
        var: prop_count.stdout_lines
